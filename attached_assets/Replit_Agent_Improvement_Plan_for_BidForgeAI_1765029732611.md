# Replit Agent Improvement Plan for BidForgeAI

**Project Goal:** Implement critical security fixes and high-impact competitive feature enhancements to maximize BidForgeAI's market advantage.

**Priority Order:** Security fixes must be implemented and tested before feature enhancements.

---

## Phase 1: Critical Security Fixes (Highest Priority)

This phase addresses the **Broken Access Control** vulnerability on the WhatsApp integration endpoints.

### Task 1.1: Secure Outbound WhatsApp Endpoints

**File:** `server/routes.ts`

**Action:** Apply the existing `authenticateToken` middleware and implement a new `requirePermission` check to all three outbound WhatsApp routes.

**Implementation Steps:**

1.  **Locate Routes:** Find the following routes in `server/routes.ts`:
    *   `POST /api/whatsapp/send`
    *   `POST /api/whatsapp/send-document`
    *   `POST /api/whatsapp/send-template`
2.  **Apply Middleware:** Modify the route definitions to include `authenticateToken` and a placeholder for the new permission check.

    **Example Modification (Conceptual):**
    ```typescript
    // BEFORE (Conceptual)
    app.post("/api/whatsapp/send", async (req, res) => { /* ... */ });

    // AFTER (Conceptual - assuming a new permission 'whatsapp:send' is defined in rbac.ts)
    app.post("/api/whatsapp/send", authenticateToken, requirePermission('whatsapp:send'), async (req: AuthRequest, res) => { /* ... */ });
    ```
3.  **Define Permission:** Ensure the `PERMISSIONS` object in `server/middleware/rbac.ts` includes a new permission: `whatsapp:send`.

---

## Phase 2: Competitive Feature Enhancements

This phase focuses on leveraging BidForgeAI's unique strengths (Risk Analysis and Workflow) to maximize its competitive edge against AutoRFP.ai.

### Task 2.1: Feature Enhancement 1: Automated "Go/No-Go" Decision Visualization

**Goal:** Provide a clear, auditable, and visual summary of the Decision Agent's logic, a key differentiator against simpler drafting tools.

**Files:** `server/routes.ts` (for a new endpoint), `shared/schema.ts` (for data structure), and frontend components (conceptual).

**Implementation Steps:**

1.  **Schema Update (`shared/schema.ts`):** Define a new schema for the Decision Log that includes the scores and the rule that triggered the final decision.
    ```typescript
    // Example addition to shared/schema.ts
    export const decisionLogSchema = z.object({
      doabilityScore: z.number(),
      minDoabilityThreshold: z.number(),
      criticalRiskLevel: z.boolean(),
      decision: z.enum(['PROCEED', 'REJECT']),
      reason: z.string(),
      triggeredRule: z.string(), // e.g., "Doability Score below 30"
    });
    ```
2.  **Agent Update (`server/agents/decision-agent.ts`):** Ensure the `DecisionAgent`'s output conforms to this new schema and saves the detailed log to the `agentStates` or a new `decisionLogs` table.
3.  **New API Endpoint (`server/routes.ts`):** Create a new authenticated endpoint to retrieve this decision log for a given project:
    *   `GET /api/projects/:id/decision-log`

### Task 2.2: Feature Enhancement 2: Dynamic Win Probability Feature Weighting

**Goal:** Enhance the Win Probability model to be more transparent and actionable, directly linking project features to the final score.

**Files:** `server/lib/win-probability.ts`, `shared/schema.ts`.

**Implementation Steps:**

1.  **Schema Update (`shared/schema.ts`):** The `winProbabilityPredictions` table already has `featureScores` and `featureWeights`. The enhancement is to ensure the `breakdown` field is always populated with a clear, human-readable explanation of how each feature contributed to the final score.
2.  **Logic Update (`server/lib/win-probability.ts`):**
    *   Modify the prediction function to not only calculate the probability but also generate a simple natural language summary for the top 3 positive and top 3 negative contributing factors.
    *   The output should be a structured array of objects (e.g., `[{ factor: 'Client Relationship Score', contribution: '+15%', insight: 'Strong 9/10 rating due to 5 prior successful projects.' }]`).
    *   This structured output should be saved to the `breakdown` field in the `winProbabilityPredictions` table.

### Task 2.3: Feature Enhancement 3: Multi-Model RAG Comparison

**Goal:** Leverage the existing multi-model support to allow users to compare bid drafts generated by different LLMs side-by-side, maximizing the value of the flexible architecture.

**Files:** `client/src/pages/ProjectWorkspace.tsx` (conceptual), `server/routes.ts`.

**Implementation Steps:**

1.  **API Modification (`POST /api/projects/:id/generate` in `server/routes.ts`):**
    *   Modify the `generateBidSchema` to accept an optional array of models (e.g., `models: z.array(z.enum(['openai', 'anthropic', 'gemini', 'deepseek'])).optional()`).
    *   If a single model is provided, the current logic runs.
    *   If an array of models is provided, the endpoint should execute the generation logic for each model in parallel and return an array of results: `[{ model: 'openai', html: '...' }, { model: 'anthropic', html: '...' }]`.
2.  **Frontend Integration (Conceptual):** The client-side UI should be updated to display a "Compare Drafts" button, which triggers the multi-model generation and presents the results in a tabbed or side-by-side view.

---

## Testing and Verification

The Replit Agent must verify the following after implementation:

1.  **Security Test:** Attempt to call the WhatsApp API endpoints (`/api/whatsapp/send`, etc.) without a valid JWT. The response **MUST** be a `401 Unauthorized` or `403 Forbidden`.
2.  **Feature Test (Task 2.1):** Call the new `/api/projects/:id/decision-log` endpoint and verify the returned JSON contains the `decision`, `reason`, and `triggeredRule` fields.
3.  **Feature Test (Task 2.3):** Call the `POST /api/projects/:id/generate` endpoint with a request body specifying two different models (e.g., `["openai", "anthropic"]`) and verify the response is an array containing two distinct HTML drafts.

**Upon successful completion of all tasks and verification steps, the Agent should report the changes and the successful test results.**
